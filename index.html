<html>

<header>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
	
	<script src="js/TileLayer.TileJSON.js"></script>
	
	<script src="js/proj4-compressed.js"></script>
	<script src="js/proj4leaflet.js"></script>
</header>

<body>
	<div id="map" style="width:100%;height: 100%"></div>
	<script>
		var map = L.map('map',{
			//crs: new L.Proj.CRS("EPSG:32719","+proj=utm +zone=19 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs ")
		}).setView([-0.2298500, -78.5249500], 8);
		L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
		    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
		    maxZoom: 18
		}).addTo(map);

		var requests = 0;

		var aricaLayer = new L.TileLayer.TileJSON({
	        debug: false,
	        // this value should be equal to 'radius' of your points        
	        buffer: 5,
	        request: {
	        	dataType: "jsonp",
	        	jsonp: false
	        }
	    });
	    aricaLayer.createRequest = function (bounds) {
	    	if(!this.proj) {
	    		this.proj = new L.Proj.CRS("EPSG:32719","+proj=utm +zone=19 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs ");
	    	}

	    	var min = this.proj.latLngToPoint(L.latLng(bounds[1],bounds[0]));
	    	var max = this.proj.latLngToPoint(L.latLng(bounds[3],bounds[2]));

	    	requests++;

	    	var requestCallback = "parseRequest"+requests;

	    	//var url = 'http://localhost/geoserver/wfs?SERVICE=WFS&version=1.1.0&request=GetFeature&typeName=comunas&outputFormat=application/json&srsName=EPSG:4326'
	        
	        var url = ['http://sir.gorearicayparinacota.cl/geoserver/wfs?SERVICE=WFS&version=1.1.0&request=GetFeature&typeName=comunas&outputFormat=text/javascript&srsName=EPSG:4326&format_options=callback:'+requestCallback+'&BBOX=',
	            min.x, ',',
	            min.y, ',',
	            max.x, ',',
	            -max.y
	        ].join('');
	        return { url:url, jsonpCallback: requestCallback};
	    };
	    aricaLayer.styleFor = function (feature) {
	        var type = feature.geometry.type;
	        switch (type) {
	            case 'Point':
	            case 'MultiPoint':
	                return {
	                    color: 'rgba(252,146,114,0.6)',
	                    radius: 5
	                };
	                
	            case 'LineString':
	            case 'MultiLineString':
	                return {
	                    color: 'rgba(161,217,155,0.8)',
	                    size: 3
	                };
	 
	            case 'Polygon':
	            case 'MultiPolygon':
	                return {
	                    color: 'rgba(43,140,190,0.4)',
	                    outline: {
	                        color: 'rgb(0,0,0)',
	                        size: 1
	                    }
	                };
	 
	            default:
	                return null;
	        }
	    };
	    //aricaLayer.addTo(map);

	    var trafficLayer =  new L.TileLayer.TileJSON({
	        debug: false,
	        // this value should be equal to 'radius' of your points        
	        buffer: 5,
	        request: {
	        	dataType: "jsonp",
	        	jsonp: false
	        }
	    });

	    trafficLayer.createRequest = function (bounds) {	    	
	    	requests++;

	    	var requestCallback = "parseRequest"+requests;

	    	//var url = 'http://localhost/geoserver/wfs?SERVICE=WFS&version=1.1.0&request=GetFeature&typeName=comunas&outputFormat=application/json&srsName=EPSG:4326'
	        
	        var url = ['http://37.139.29.45:8080/geoserver/wfs?request=GetFeature&typeName=icm_traffic&outputFormat=text/javascript&srsName=EPSG:4326&format_options=callback:'+requestCallback+'&BBOX=',
	            bounds[1], ',',
	            bounds[0], ',',
	            bounds[3], ',',
	            bounds[2]
	        ].join('');
	        return { url:url, jsonpCallback: requestCallback};
	    };

	    trafficLayer.styleFor = function (feature) {
	        var type = feature.geometry.type;
	        switch (type) {
	            case 'Point':
	            case 'MultiPoint':
	                return {
	                    color: 'rgba(252,146,114,0.6)',
	                    radius: 5
	                };
	                
	            case 'LineString':
	            case 'MultiLineString':
	            	console.debug(feature.properties.travel_time)
	            	if(feature.properties.link_type_id!=33) {
	            		 return {
		                    color: 'rgba(0,0,0,0.8)',
		                    size: 3
		                };
	            	}

	                return {
	                    color: 'rgba(255,0,0,0.8)',
	                    size: 3,
	                    offset: 2
	                };
	 
	            case 'Polygon':
	            case 'MultiPolygon':
	                return {
	                    color: 'rgba(43,140,190,0.4)',
	                    outline: {
	                        color: 'rgb(0,0,0)',
	                        size: 1
	                    }
	                };
	 
	            default:
	                return null;
	        }
	    };

	    trafficLayer.addTo(map)
	</script>
</body>
</html>